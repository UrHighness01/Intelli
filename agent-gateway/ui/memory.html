<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Intelli Memory</title>
<style>
  :root {
    --surface:  #1a1d27;
    --surface2: #21253a;
    --border:   #2d3145;
    --accent:   #6e9ef5;
    --green:    #3ddc84;
    --red:      #ff6b6b;
    --yellow:   #ffd166;
    --text:     #e2e4f0;
    --muted:    #7b7f9e;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--surface);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #header {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }
  #header h1 { font-size: 1rem; font-weight: 600; flex: 1; }
  #stat-count { font-size: .72rem; color: var(--muted); }
  #backend-pill {
    font-size: .65rem; padding: 2px 7px;
    border-radius: 10px; border: 1px solid var(--border);
    color: var(--muted);
  }
  #search-bar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 8px 12px;
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }
  #search-bar input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px;
    color: var(--text);
    font-size: .85rem;
    outline: none;
  }
  #search-bar input:focus { border-color: var(--accent); }
  #search-bar input::placeholder { color: var(--muted); }
  .btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    cursor: pointer;
    font-size: .8rem;
    padding: 5px 12px;
    white-space: nowrap;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn.primary { border-color: var(--accent); color: var(--accent); }
  #tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    flex-shrink: 0;
  }
  .tab {
    padding: 6px 14px;
    font-size: .78rem;
    cursor: pointer;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    transition: color .15s;
  }
  .tab.active { color: var(--accent); border-color: var(--accent); }
  .tab:hover { color: var(--text); }
  #list-pane {
    flex: 1;
    overflow-y: auto;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .memory-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    transition: border-color .15s;
  }
  .memory-card:hover { border-color: var(--accent); }
  .memory-card.pinned { border-left: 3px solid var(--yellow); }
  .card-top {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 5px;
  }
  .source-badge {
    font-size: .62rem;
    padding: 1px 6px;
    border-radius: 10px;
    border: 1px solid var(--border);
    color: var(--muted);
    white-space: nowrap;
    flex-shrink: 0;
  }
  .source-badge.page   { border-color: var(--accent); color: var(--accent); }
  .source-badge.chat   { border-color: var(--green);  color: var(--green);  }
  .source-badge.manual { border-color: var(--yellow); color: var(--yellow); }
  .card-url {
    font-size: .72rem;
    color: var(--accent);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    text-decoration: none;
  }
  .card-url:hover { text-decoration: underline; }
  .card-age { font-size: .65rem; color: var(--muted); flex-shrink: 0; }
  .card-text {
    font-size: .8rem;
    color: var(--text);
    line-height: 1.45;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .card-text.expanded { display: block; -webkit-line-clamp: unset; }
  .card-footer {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
  }
  .score-pill {
    font-size: .62rem;
    color: var(--green);
    border: 1px solid var(--green);
    border-radius: 10px;
    padding: 1px 5px;
  }
  .spacer { flex: 1; }
  .del-btn {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: .75rem;
    padding: 2px 5px;
    border-radius: 4px;
  }
  .del-btn:hover { color: var(--red); }
  .expand-btn {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: .72rem;
    padding: 0 3px;
  }
  .expand-btn:hover { color: var(--text); }
  #add-pane {
    display: none;
    flex: 1;
    padding: 14px;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
  }
  #add-pane.visible { display: flex; }
  #add-pane label { font-size: .78rem; color: var(--muted); margin-bottom: 2px; }
  #add-pane textarea, #add-pane input[type=text] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: .82rem;
    padding: 7px 10px;
    width: 100%;
    outline: none;
  }
  #add-pane textarea { height: 120px; resize: vertical; }
  #add-pane textarea:focus, #add-pane input:focus { border-color: var(--accent); }
  .empty { text-align: center; color: var(--muted); font-size: .85rem; padding: 40px 0; }
  #status-bar {
    background: var(--surface2);
    border-top: 1px solid var(--border);
    padding: 4px 12px;
    font-size: .7rem;
    color: var(--muted);
    flex-shrink: 0;
  }
</style>
</head>
<body>

<div id="header">
  <h1>ðŸ§  Vector Memory</h1>
  <span id="stat-count">â€” memories</span>
  <span id="backend-pill">â€¦</span>
</div>

<div id="search-bar">
  <input id="inp-search" type="text" placeholder="Search memories semanticallyâ€¦" />
  <button class="btn primary" onclick="doSearch()">Search</button>
  <button class="btn" onclick="loadRecent()">Recent</button>
</div>

<div id="tabs">
  <div class="tab active" data-tab="list"   onclick="switchTab('list')">All</div>
  <div class="tab"        data-tab="page"   onclick="switchTab('page')">Pages</div>
  <div class="tab"        data-tab="chat"   onclick="switchTab('chat')">Chats</div>
  <div class="tab"        data-tab="manual" onclick="switchTab('manual')">Pinned</div>
  <div class="tab"        data-tab="add"    onclick="switchTab('add')">+ Pin new</div>
</div>

<div id="list-pane">
  <div class="empty">Loadingâ€¦</div>
</div>

<div id="add-pane">
  <div>
    <label>Text / Fact to remember *</label>
    <textarea id="add-text" placeholder="Anything the agent should recall across sessionsâ€¦"></textarea>
  </div>
  <div>
    <label>Title (optional)</label>
    <input id="add-title" type="text" placeholder="Short label">
  </div>
  <div>
    <label>URL (optional)</label>
    <input id="add-url" type="text" placeholder="https://â€¦">
  </div>
  <button class="btn primary" onclick="pinMemory()" style="align-self:flex-start">ðŸ“Œ Save memory</button>
</div>

<div id="status-bar">Ready</div>

<script>
  const GW     = 'http://127.0.0.1:8080';
  const _token = localStorage.getItem('gw_token') || '';
  let _activeTab = 'list';

  const $list    = document.getElementById('list-pane');
  const $addPane = document.getElementById('add-pane');
  const $status  = document.getElementById('status-bar');
  const $count   = document.getElementById('stat-count');
  const $backend = document.getElementById('backend-pill');
  const $search  = document.getElementById('inp-search');

  function hdr() { return { Authorization: `Bearer ${_token}`, 'Content-Type': 'application/json' }; }
  function setStatus(msg) { $status.textContent = msg; }

  async function loadStats() {
    try {
      const r = await fetch(`${GW}/memory/stats`, { headers: hdr() });
      if (!r.ok) return;
      const d = await r.json();
      $count.textContent   = `${d.count} memor${d.count === 1 ? 'y' : 'ies'}`;
      $backend.textContent = d.backend;
    } catch (_) {}
  }

  function switchTab(tab) {
    _activeTab = tab;
    $search.value = '';
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    $addPane.classList.toggle('visible', tab === 'add');
    $list.style.display = tab === 'add' ? 'none' : '';
    if (tab === 'add') return;
    tab === 'list' ? loadRecent() : loadBySource(tab);
  }

  async function loadRecent() {
    setStatus('Loadingâ€¦');
    try {
      const r = await fetch(`${GW}/memory/list?n=40`, { headers: hdr() });
      if (!r.ok) { renderError(r.status); return; }
      const d = await r.json();
      renderCards(d.memories, false);
      setStatus(`${d.memories.length} recent memories`);
    } catch (e) { renderError(e.message); }
    loadStats();
  }

  async function loadBySource(source) {
    setStatus('Loadingâ€¦');
    try {
      const r = await fetch(`${GW}/memory/search?q=the&n=40&source=${source}`, { headers: hdr() });
      if (!r.ok) { renderError(r.status); return; }
      const d = await r.json();
      renderCards(d.results, false);
      setStatus(`${d.results.length} ${source} memories`);
    } catch (e) { renderError(e.message); }
  }

  async function doSearch() {
    const q = $search.value.trim();
    if (!q) { loadRecent(); return; }
    setStatus('Searchingâ€¦');
    try {
      const src = (_activeTab !== 'list' && _activeTab !== 'add') ? `&source=${_activeTab}` : '';
      const r = await fetch(`${GW}/memory/search?q=${encodeURIComponent(q)}&n=10${src}`, { headers: hdr() });
      if (!r.ok) { renderError(r.status); return; }
      const d = await r.json();
      renderCards(d.results, true);
      setStatus(`${d.results.length} results for "${q}"`);
    } catch (e) { renderError(e.message); }
  }

  $search.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

  function renderCards(items, showScore) {
    $list.innerHTML = '';
    if (!items.length) { $list.innerHTML = '<div class="empty">No memories found.</div>'; return; }
    items.forEach(item => {
      const meta   = item.metadata || {};
      const source = meta.source  || 'manual';
      const url    = meta.url     || '';
      const title  = meta.title   || '';
      const pinned = !!meta.pinned;
      const ts     = meta.timestamp_unix || 0;
      const docId  = meta.doc_id || item.id || '';
      const text   = item.text   || '';
      const score  = item.score;
      const textId = 'txt_' + docId.replace(/[^a-z0-9]/gi, '_');

      const card = document.createElement('div');
      card.className = 'memory-card' + (pinned ? ' pinned' : '');
      card.dataset.id = docId;
      card.innerHTML = `
        <div class="card-top">
          <span class="source-badge ${source}">${source}</span>
          ${url
            ? `<a class="card-url" href="${esc(url)}" target="_blank">${esc(url)}</a>`
            : `<span class="card-url" style="color:var(--muted)">${esc(title) || '(no url)'}</span>`}
          <span class="card-age">${fmtAge(ts)}</span>
        </div>
        <div class="card-text" id="${textId}">${esc(text)}</div>
        <div class="card-footer">
          ${pinned ? '<span style="font-size:.75rem;color:var(--yellow)">ðŸ“Œ</span>' : ''}
          ${showScore && score != null ? `<span class="score-pill">${(score*100).toFixed(0)}%</span>` : ''}
          <span class="spacer"></span>
          <button class="expand-btn" onclick="toggleExpand('${textId}',this)">â–¼ more</button>
          <button class="del-btn" title="Forget" onclick="delMem('${esc(docId)}',this)">âœ•</button>
        </div>`;
      $list.appendChild(card);
    });
  }

  function toggleExpand(id, btn) {
    const el = document.getElementById(id);
    el.classList.toggle('expanded');
    btn.textContent = el.classList.contains('expanded') ? 'â–² less' : 'â–¼ more';
  }

  async function delMem(docId, btn) {
    if (!confirm('Forget this memory?')) return;
    btn.disabled = true;
    try {
      const r = await fetch(`${GW}/memory/${encodeURIComponent(docId)}`, { method: 'DELETE', headers: hdr() });
      if (r.ok) {
        document.querySelector(`.memory-card[data-id="${docId}"]`)?.remove();
        setStatus('Memory forgotten'); loadStats();
      } else { btn.disabled = false; setStatus('Delete failed'); }
    } catch (e) { btn.disabled = false; setStatus(`Error: ${e.message}`); }
  }

  async function pinMemory() {
    const text  = document.getElementById('add-text').value.trim();
    const title = document.getElementById('add-title').value.trim();
    const url   = document.getElementById('add-url').value.trim();
    if (!text) { setStatus('Text is required'); return; }
    try {
      const r = await fetch(`${GW}/memory/add`, {
        method: 'POST', headers: hdr(),
        body: JSON.stringify({ text, title, url, source: 'manual', pinned: true }),
      });
      if (r.ok) {
        document.getElementById('add-text').value = '';
        document.getElementById('add-title').value = '';
        document.getElementById('add-url').value = '';
        setStatus('âœ“ Memory saved'); loadStats();
      } else { const e = await r.json(); setStatus(`Failed: ${e.detail}`); }
    } catch (e) { setStatus(`Error: ${e.message}`); }
  }

  function renderError(code) {
    $list.innerHTML = `<div class="empty" style="color:var(--red)">Error ${code} â€” check login token.</div>`;
  }

  function fmtAge(ts) {
    if (!ts) return '';
    const age = Date.now() / 1000 - ts;
    if (age < 3600)  return `${Math.round(age/60)}m ago`;
    if (age < 86400) return `${Math.round(age/3600)}h ago`;
    return `${Math.round(age/86400)}d ago`;
  }

  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  loadStats();
  loadRecent();
</script>
</body>
</html>

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; min-height: 100vh; }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 18px 28px;
      display: flex; align-items: center; gap: 16px;
    }
    header h1 { font-size: 1.25rem; font-weight: 600; }
    header span { color: var(--muted); font-size: .85rem; }

    main { padding: 24px 28px; display: grid; grid-template-columns: 240px 1fr; gap: 20px; max-width: 1200px; margin: 0 auto; }

    /* -- Auth ---------------------------------------------------------------- */
    #auth-panel {
      grid-column: 1 / -1;
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 14px 18px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    #auth-panel label { color: var(--muted); font-size: .85rem; white-space: nowrap; }
    #token-input {
      flex: 1; min-width: 220px;
      background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 12px; color: var(--text); font-family: monospace; font-size: .85rem; outline: none;
    }
    #token-input:focus { border-color: var(--accent); }

    button {
      background: var(--accent); color: #fff; border: none; border-radius: 6px;
      padding: 6px 16px; font-size: .82rem; cursor: pointer; font-weight: 600; white-space: nowrap;
    }
    button:hover { opacity: .85; }
    button.danger { background: #7f2a2a; }
    button.secondary { background: var(--border); color: var(--text); }
    button.sm { padding: 4px 10px; font-size: .78rem; }

    /* -- Agent list --------------------------------------------------------- */
    #agent-panel {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      overflow: hidden; align-self: start;
    }
    #agent-panel h2 { padding: 12px 16px; font-size: .9rem; font-weight: 500; border-bottom: 1px solid var(--border); color: var(--muted); }
    #agent-list { list-style: none; }
    #agent-list li {
      padding: 10px 16px; cursor: pointer; font-size: .85rem;
      border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px;
    }
    #agent-list li:last-child { border: none; }
    #agent-list li:hover { background: rgba(108,99,255,.07); }
    #agent-list li.active { background: rgba(108,99,255,.15); color: var(--accent); font-weight: 600; }
    #agent-list li .agent-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
    #agent-empty { padding: 24px 16px; color: var(--muted); font-size: .82rem; text-align: center; }
    #refresh-agents { width: 100%; border-radius: 0; background: var(--surface2); color: var(--muted); border-top: 1px solid var(--border); }

    /* -- Memory detail ------------------------------------------------------- */
    #detail-panel {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      overflow: hidden;
    }
    #detail-header {
      padding: 12px 18px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    #detail-title { font-size: .95rem; font-weight: 600; flex: 1; }
    #detail-agent-id { font-family: monospace; color: var(--accent); }

    /* Add key form */
    #add-form {
      padding: 14px 18px; border-bottom: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr 2fr auto auto auto; gap: 8px; align-items: center;
    }
    #add-form input, #add-form select {
      background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 10px; color: var(--text); font-size: .82rem; outline: none;
    }
    #add-form input:focus, #add-form select:focus { border-color: var(--accent); }
    #add-key    { font-family: monospace; }
    #add-value  { font-family: monospace; }
    #add-ttl    { width: 90px; }
    #add-form label { font-size: .78rem; color: var(--muted); white-space: nowrap; }

    /* Memory table */
    #memory-table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: .84rem; }
    thead th { text-align: left; padding: 9px 16px; color: var(--muted); font-weight: 500; border-bottom: 1px solid var(--border); }
    tbody tr { border-bottom: 1px solid var(--border); }
    tbody tr:last-child { border: none; }
    tbody tr:hover { background: rgba(108,99,255,.04); }
    td { padding: 9px 16px; }
    td.key   { font-family: monospace; color: var(--accent); word-break: break-all; }
    td.value { font-family: monospace; font-size: .8rem; word-break: break-all; max-width: 340px; }
    td.expiry { font-size: .78rem; color: var(--muted); white-space: nowrap; }
    td.expiry.warn { color: var(--yellow); }
    td.expiry.expired { color: var(--red); }
    td.actions { white-space: nowrap; }
    td.actions button { margin-left: 6px; }

    .empty-state { padding: 40px 16px; text-align: center; color: var(--muted); font-size: .88rem; }
    .placeholder { color: var(--muted); font-style: italic; }

    /* Toast */
    #toast {
      position: fixed; bottom: 28px; right: 28px;
      background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
      padding: 10px 18px; font-size: .85rem; color: var(--text);
      transform: translateY(80px); opacity: 0; transition: all .2s;
      pointer-events: none; z-index: 999;
    }
    #toast.show { transform: translateY(0); opacity: 1; }
    #toast.ok  { border-color: var(--green); }
    #toast.err { border-color: var(--red); }

    /* Edit inline */
    .edit-input {
      background: var(--bg); border: 1px solid var(--accent); border-radius: 4px;
      padding: 3px 7px; color: var(--text); font-family: monospace; font-size: .8rem;
      outline: none; width: 100%; min-width: 120px;
    }
  </style>
</head>
<body>

<header>
  <h1>Intelli Gateway</h1>
  <span>Agent Memory</span>
</header>

<main>
  <!-- Auth -->
  <div id="auth-panel">
    <label for="token-input">Bearer token</label>
    <input type="password" id="token-input" placeholder="Paste admin tokenâ€¦" />
    <button onclick="loadAgents()">Connect</button>
  </div>

  <!-- Agent list (left column) -->
  <div id="agent-panel">
    <h2>Agents</h2>
    <ul id="agent-list"><li id="agent-empty">No agents loaded.</li></ul>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px">
      <button id="refresh-agents" onclick="loadAgents()">âŸ³ Refresh</button>
      <button class="secondary" onclick="exportAll()" title="Download all agent memories as JSON">â¬‡ Export all</button>
      <button class="secondary" onclick="document.getElementById('import-file').click()" title="Import from a previously exported JSON file">â¬† Import</button>
    </div>
    <input type="file" id="import-file" accept=".json,application/json" style="display:none" onchange="importAll(this)" />
  </div>

  <!-- Memory detail (right column) -->
  <div id="detail-panel">
    <div id="detail-header">
      <span id="detail-title">Select an agent â†’</span>
      <button class="secondary sm" id="btn-prune" onclick="pruneAgent()" style="display:none">Prune expired</button>
      <button class="danger sm" id="btn-clear" onclick="clearAgent()" style="display:none">Clear all</button>
    </div>

    <!-- Add / upsert key form -->
    <div id="add-form" style="display:none">
      <input type="text" id="add-key" placeholder="key" />
      <input type="text" id="add-value" placeholder='value (JSON or string)' />
      <input type="number" id="add-ttl" placeholder="TTL (s)" min="0" step="1" />
      <button onclick="addKey()">Set</button>
    </div>

    <!-- Table -->
    <div id="memory-table-wrap">
      <table id="memory-table" style="display:none">
        <thead>
          <tr>
            <th>Key</th>
            <th>Value</th>
            <th>Expires at</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="memory-body"></tbody>
      </table>
      <div id="memory-empty" class="empty-state" style="display:none">No memory keys for this agent.</div>
      <div id="memory-placeholder" class="empty-state placeholder">Select an agent from the left panel.</div>
    </div>
  </div>
</main>

<div id="toast"></div>

<script>
  /* â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let _currentAgent = null;

  function token() {
    return document.getElementById('token-input').value.trim();
  }

  function headers() {
    const t = token();
    return t ? { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
  }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let _toastTimer = null;
  function toast(msg, type = 'ok') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = `show ${type}`;
    clearTimeout(_toastTimer);
    _toastTimer = setTimeout(() => { el.className = ''; }, 2800);
  }

  /* â”€â”€ Agents list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function loadAgents() {
    try {
      const r = await fetch('/agents', { headers: headers() });
      if (!r.ok) { toast(`Failed to load agents: ${r.status}`, 'err'); return; }
      const { agents } = await r.json();
      renderAgentList(agents);
    } catch (e) {
      toast('Cannot reach gateway', 'err');
    }
  }

  function renderAgentList(agents) {
    const ul = document.getElementById('agent-list');
    ul.innerHTML = '';
    if (!agents.length) {
      ul.innerHTML = '<li id="agent-empty">No agents with memory.</li>';
      return;
    }
    for (const id of agents) {
      const li = document.createElement('li');
      if (id === _currentAgent) li.className = 'active';
      li.innerHTML = `<span class="agent-dot"></span>${escHtml(id)}`;
      li.onclick = () => selectAgent(id);
      ul.appendChild(li);
    }
  }

  function selectAgent(id) {
    _currentAgent = id;
    // Highlight
    document.querySelectorAll('#agent-list li').forEach(li => {
      li.className = li.textContent.trim() === id ? 'active' : '';
    });
    document.getElementById('detail-title').innerHTML =
      `Agent: <span id="detail-agent-id">${escHtml(id)}</span>`;
    document.getElementById('btn-prune').style.display = '';
    document.getElementById('btn-clear').style.display = '';
    document.getElementById('add-form').style.display = '';
    loadMemory(id);
  }

  /* â”€â”€ Memory keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function loadMemory(agentId) {
    document.getElementById('memory-placeholder').style.display = 'none';
    document.getElementById('memory-empty').style.display = 'none';
    document.getElementById('memory-table').style.display = 'none';

    try {
      const r = await fetch(`/agents/${encodeURIComponent(agentId)}/memory`, { headers: headers() });
      if (!r.ok) { toast(`Error ${r.status}`, 'err'); return; }
      const { memory } = await r.json();
      renderMemory(agentId, memory);
    } catch (e) {
      toast('Request failed', 'err');
    }
  }

  async function loadMemoryWithMeta(agentId, keys) {
    /* For each key, fetch the full metadata (value + expires_at) */
    const results = {};
    await Promise.all(keys.map(async k => {
      try {
        const r = await fetch(
          `/agents/${encodeURIComponent(agentId)}/memory/${encodeURIComponent(k)}`,
          { headers: headers() }
        );
        if (r.ok) results[k] = await r.json();
      } catch (_) {}
    }));
    return results;
  }

  async function renderMemory(agentId, memory) {
    const keys = Object.keys(memory);
    const tbody = document.getElementById('memory-body');
    tbody.innerHTML = '';

    if (!keys.length) {
      document.getElementById('memory-empty').style.display = '';
      return;
    }

    document.getElementById('memory-table').style.display = '';
    const meta = await loadMemoryWithMeta(agentId, keys);

    for (const k of keys) {
      const m = meta[k] || { value: memory[k], expires_at: null };
      tbody.appendChild(buildRow(agentId, k, m.value, m.expires_at));
    }
  }

  function buildRow(agentId, key, value, expiresAt) {
    const tr = document.createElement('tr');
    tr.dataset.key = key;

    const expiryStr = formatExpiry(expiresAt);
    const expiryClass = expiryClass_(expiresAt);

    tr.innerHTML = `
      <td class="key">${escHtml(key)}</td>
      <td class="value" title="${escHtml(JSON.stringify(value))}">${escHtml(truncate(JSON.stringify(value), 120))}</td>
      <td class="expiry ${expiryClass}">${expiryStr}</td>
      <td class="actions">
        <button class="sm secondary" onclick="editKey(this, '${escAttr(agentId)}', '${escAttr(key)}', ${escAttr(JSON.stringify(value))})">Edit</button>
        <button class="sm danger" onclick="deleteKey('${escAttr(agentId)}', '${escAttr(key)}')">Delete</button>
      </td>
    `;
    return tr;
  }

  function formatExpiry(ts) {
    if (ts == null) return 'â€”';
    const d = new Date(ts * 1000);
    const now = Date.now();
    if (d.getTime() < now) return 'âš  expired';
    const diffS = Math.round((d.getTime() - now) / 1000);
    if (diffS < 60)   return `in ${diffS}s`;
    if (diffS < 3600) return `in ${Math.round(diffS/60)}m`;
    if (diffS < 86400) return `in ${Math.round(diffS/3600)}h`;
    return d.toLocaleString();
  }

  function expiryClass_(ts) {
    if (ts == null) return '';
    const now = Date.now() / 1000;
    if (ts < now) return 'expired';
    if (ts - now < 300) return 'warn';
    return '';
  }

  /* â”€â”€ Add / upsert key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function addKey() {
    if (!_currentAgent) return;
    const keyEl   = document.getElementById('add-key');
    const valEl   = document.getElementById('add-value');
    const ttlEl   = document.getElementById('add-ttl');

    const key = keyEl.value.trim();
    if (!key) { toast('Key is required', 'err'); return; }

    let value;
    try { value = JSON.parse(valEl.value); }
    catch { value = valEl.value; }   // treat as raw string

    const ttl = ttlEl.value ? parseFloat(ttlEl.value) : null;

    await upsertKey(_currentAgent, key, value, ttl);
    keyEl.value = '';
    valEl.value = '';
    ttlEl.value = '';
  }

  async function upsertKey(agentId, key, value, ttlSeconds) {
    const body = { key, value };
    if (ttlSeconds != null) body.ttl_seconds = ttlSeconds;

    try {
      const r = await fetch(`/agents/${encodeURIComponent(agentId)}/memory`, {
        method: 'POST',
        headers: headers(),
        body: JSON.stringify(body),
      });
      if (!r.ok) { toast(`Error ${r.status}`, 'err'); return; }
      toast(`Key "${key}" stored`, 'ok');
      await loadMemory(agentId);
    } catch (e) {
      toast('Request failed', 'err');
    }
  }

  /* â”€â”€ Edit key inline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function editKey(btn, agentId, key, currentValue) {
    const row = btn.closest('tr');
    const valTd = row.querySelector('td.value');

    // Already editing?
    if (valTd.querySelector('input')) return;

    const input = document.createElement('input');
    input.className = 'edit-input';
    input.value = typeof currentValue === 'string' ? currentValue : JSON.stringify(currentValue);
    valTd.innerHTML = '';
    valTd.appendChild(input);
    input.focus();

    btn.textContent = 'Save';
    btn.onclick = async () => {
      let newVal;
      try { newVal = JSON.parse(input.value); } catch { newVal = input.value; }
      btn.onclick = null;
      await upsertKey(agentId, key, newVal, null);
    };

    input.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
        let newVal;
        try { newVal = JSON.parse(input.value); } catch { newVal = input.value; }
        await upsertKey(agentId, key, newVal, null);
      }
      if (e.key === 'Escape') loadMemory(agentId);
    });
  }

  /* â”€â”€ Delete key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function deleteKey(agentId, key) {
    if (!confirm(`Delete key "${key}" from agent "${agentId}"?`)) return;
    try {
      const r = await fetch(
        `/agents/${encodeURIComponent(agentId)}/memory/${encodeURIComponent(key)}`,
        { method: 'DELETE', headers: headers() }
      );
      if (!r.ok) { toast(`Error ${r.status}`, 'err'); return; }
      toast(`Key "${key}" deleted`, 'ok');
      await loadMemory(agentId);
    } catch (e) {
      toast('Request failed', 'err');
    }
  }

  /* â”€â”€ Clear all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function clearAgent() {
    if (!_currentAgent) return;
    if (!confirm(`Clear ALL memory for agent "${_currentAgent}"? This cannot be undone.`)) return;
    try {
      const r = await fetch(
        `/agents/${encodeURIComponent(_currentAgent)}/memory`,
        { method: 'DELETE', headers: headers() }
      );
      if (!r.ok) { toast(`Error ${r.status}`, 'err'); return; }
      const { cleared } = await r.json();
      toast(`Cleared ${cleared} key${cleared !== 1 ? 's' : ''}`, 'ok');
      await loadMemory(_currentAgent);
    } catch (e) {
      toast('Request failed', 'err');
    }
  }

  /* â”€â”€ Prune expired â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function pruneAgent() {
    if (!_currentAgent) return;
    try {
      const r = await fetch(
        `/agents/${encodeURIComponent(_currentAgent)}/memory/prune`,
        { method: 'POST', headers: headers() }
      );
      if (!r.ok) { toast(`Error ${r.status}`, 'err'); return; }
      const { pruned } = await r.json();
      toast(`Pruned ${pruned} expired key${pruned !== 1 ? 's' : ''}`, 'ok');
      await loadMemory(_currentAgent);
    } catch (e) {
      toast('Request failed', 'err');
    }
  }

  /* â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function escAttr(s) {
    return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');
  }
  function truncate(s, n) {
    return s.length > n ? s.slice(0, n) + 'â€¦' : s;
  }

  /* â”€â”€ Export all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function exportAll() {
    const t = token();
    if (!t) { toast('Connect first', 'err'); return; }
    try {
      const r = await fetch('/admin/memory/export', {
        headers: { 'Authorization': `Bearer ${t}` },
      });
      if (!r.ok) { toast(`Export failed: ${r.status}`, 'err'); return; }
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'memory-export.json';
      a.click();
      URL.revokeObjectURL(url);
      toast('Export downloaded', 'ok');
    } catch (e) { toast('Export failed', 'err'); }
  }

  /* â”€â”€ Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function importAll(input) {
    const file = input.files[0];
    if (!file) return;
    const t = token();
    if (!t) { toast('Connect first', 'err'); return; }
    const replace = confirm('Replace existing memory?\nOK = replace, Cancel = merge');
    try {
      const text = await file.text();
      const parsed = JSON.parse(text);
      // Export format: {agents:{...}, ...} or bare {agent-id:{...}}
      const agents = parsed.agents ?? parsed;
      const r = await fetch('/admin/memory/import', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ agents, merge: !replace }),
      });
      if (!r.ok) { toast(`Import failed: ${r.status}`, 'err'); return; }
      const d = await r.json();
      toast(`Imported ${d.imported_agents ?? '?'} agent(s), ${d.imported_keys ?? '?'} key(s)`, 'ok');
      await loadAgents();
    } catch (e) { toast('Import failed: ' + e.message, 'err'); }
    input.value = '';
  }

  /* â”€â”€ Startup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  window.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('gw_token');
    if (saved) {
      document.getElementById('token-input').value = saved;
      loadAgents();
    }
  });
  document.getElementById('token-input').addEventListener('change', () => {
    localStorage.setItem('gw_token', token());
  });
</script>
  <script type="module" src="i18n.js"></script>
</body>
</html>
