<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intelli · AI Chat</title>
  <style>
    :root {
      --bg:      #0f1117;
      --surface: #1a1d27;
      --surface2:#21253a;
      --border:  #2d3145;
      --accent:  #6c63ff;
      --accent2: #a78bfa;
      --green:   #3ddc84;
      --red:     #ff6b6b;
      --yellow:  #ffd166;
      --text:    #e2e4f0;
      --muted:   #7b7f9e;
      --user-bg: #2a2d40;
      --ai-bg:   #1e2136;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Header ──────────────────────────────────────────────────── */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .logo { font-size: 1.1rem; font-weight: 800; color: var(--accent); letter-spacing: -.02em; }
    .logo span { color: var(--accent2); }
    header h1 { font-size: .85rem; font-weight: 600; flex: 1; }
    .header-actions { display: flex; gap: 4px; }
    .header-btn {
      background: var(--surface2); border: 1px solid var(--border); color: var(--muted);
      border-radius: 5px; padding: 3px 8px; font-size: .72rem; cursor: pointer;
      text-decoration: none; display: inline-flex; align-items: center; gap: 4px;
    }
    .header-btn:hover { color: var(--text); border-color: var(--accent); }

    /* ── Login bar (shown when no token) ─────────────────────────── */
    #login-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    #login-bar.hidden { display: none; }
    #login-bar label { color: var(--muted); font-size: .75rem; white-space: nowrap; }
    #login-token {
      flex: 1; background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); border-radius: 5px; padding: 4px 8px; font-size: .8rem;
    }
    #login-token:focus { outline: none; border-color: var(--accent); }
    .btn-sm {
      background: var(--accent); color: #fff; border: none; border-radius: 5px;
      padding: 4px 12px; font-size: .78rem; cursor: pointer; font-weight: 600;
      white-space: nowrap;
    }
    .btn-sm:hover { background: var(--accent2); }
    .btn-sm.secondary {
      background: var(--surface2); color: var(--muted);
      border: 1px solid var(--border);
    }
    .btn-sm.secondary:hover { color: var(--text); border-color: var(--accent); }

    /* ── Config bar ───────────────────────────────────────────────── */
    #config-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 6px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }
    #config-bar label { color: var(--muted); font-size: .72rem; white-space: nowrap; }
    #config-bar select, #config-bar input[type="text"] {
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); border-radius: 4px; padding: 3px 7px; font-size: .78rem;
    }
    #config-bar select:focus, #config-bar input[type="text"]:focus {
      outline: none; border-color: var(--accent);
    }
    #sel-provider { min-width: 110px; }
    #inp-model    { width: 130px; }
    #inp-model::placeholder { color: var(--muted); }
    .spacer { flex: 1; }

    /* ── Messages area ────────────────────────────────────────────── */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 5px; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .msg {
      max-width: 95%;
      padding: 8px 12px;
      border-radius: 10px;
      line-height: 1.55;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .msg.user {
      background: var(--user-bg);
      border: 1px solid var(--border);
      align-self: flex-end;
      border-bottom-right-radius: 3px;
    }
    .msg.assistant {
      background: var(--ai-bg);
      border: 1px solid var(--border);
      align-self: flex-start;
      border-bottom-left-radius: 3px;
    }
    .msg .msg-meta {
      font-size: .68rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .msg .msg-meta .provider-badge {
      background: var(--accent);
      color: #fff;
      border-radius: 3px;
      padding: 1px 5px;
      font-size: .62rem;
      font-weight: 700;
    }
    .msg-body { font-size: .84rem; }
    .cursor {
      display: inline-block;
      width: 7px;
      height: 13px;
      background: var(--accent);
      vertical-align: middle;
      border-radius: 1px;
      animation: blink .7s step-end infinite;
      margin-left: 1px;
    }
    @keyframes blink { 50% { opacity: 0; } }
    .thinking {
      color: var(--muted);
      font-style: italic;
      font-size: .8rem;
    }
    .error-msg { color: var(--red); font-size: .82rem; }

    /* Empty state */
    #empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--muted);
      user-select: none;
      pointer-events: none;
    }
    #empty-state .big-icon { font-size: 2.5rem; opacity: .4; }
    #empty-state p { font-size: .82rem; opacity: .6; text-align: center; }

    /* ── Input area ───────────────────────────────────────────────── */
    #input-area {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 8px 12px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      flex-shrink: 0;
    }
    #msg-input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: .84rem;
      font-family: inherit;
      resize: none;
      min-height: 36px;
      max-height: 120px;
      line-height: 1.4;
      transition: border-color .15s;
    }
    #msg-input:focus { outline: none; border-color: var(--accent); }
    #msg-input::placeholder { color: var(--muted); }
    #btn-send {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: .84rem;
      cursor: pointer;
      font-weight: 600;
      flex-shrink: 0;
      transition: background .15s;
    }
    #btn-send:hover:not(:disabled) { background: var(--accent2); }
    #btn-send:disabled { opacity: .5; cursor: default; }

    /* ── Token counter ────────────────────────────────────────────── */
    #token-bar {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 3px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: .68rem;
      color: var(--muted);
      flex-shrink: 0;
    }
    .token-stat { display: flex; gap: 3px; }
    .token-stat .val { color: var(--text); font-weight: 600; }
  </style>
</head>
<body>

  <!-- ── Header ─────────────────────────────────────────────────── -->
  <header role="banner">
    <div class="logo">I<span>n</span></div>
    <h1>AI Chat</h1>
    <div class="header-actions">
      <button class="header-btn" id="btn-clear" title="Clear conversation" aria-label="Clear conversation">
        &#128465; Clear
      </button>
      <a href="index.html" class="header-btn" title="Admin Hub" aria-label="Go to Admin Hub">
        &#9881; Hub
      </a>
    </div>
  </header>

  <!-- ── Login bar ──────────────────────────────────────────────── -->
  <div id="login-bar" role="form" aria-label="Authentication">
    <label for="login-token">API Token:</label>
    <input id="login-token" type="password" placeholder="Bearer token from /admin/login" aria-label="Bearer token" />
    <button class="btn-sm" id="btn-login">Connect</button>
  </div>

  <!-- ── Config bar ─────────────────────────────────────────────── -->
  <div id="config-bar" aria-label="Chat configuration">
    <label for="sel-provider">Provider</label>
    <select id="sel-provider" aria-label="Select provider">
      <option value="openai">OpenAI</option>
      <option value="anthropic">Anthropic</option>
      <option value="openrouter">OpenRouter</option>
      <option value="ollama">Ollama</option>
    </select>
    <label for="inp-model">Model</label>
    <input id="inp-model" type="text" placeholder="optional… (e.g. gpt-4o)" aria-label="Model name (optional)" />
    <div class="spacer"></div>
    <span id="status-pill" style="font-size:.72rem;color:var(--muted)" aria-live="polite"></span>
  </div>

  <!-- ── Messages ───────────────────────────────────────────────── -->
  <div id="messages" role="log" aria-live="polite" aria-label="Conversation messages">
    <div id="empty-state">
      <div class="big-icon">&#129302;</div>
      <p>Send a message to start chatting.<br/>
         Select your provider above and connect a token.</p>
    </div>
  </div>

  <!-- ── Input area ─────────────────────────────────────────────── -->
  <div id="input-area">
    <textarea id="msg-input" rows="1" placeholder="Ask anything… (Enter to send, Shift+Enter for newline)"
              aria-label="Message input" aria-multiline="true"></textarea>
    <button id="btn-send" aria-label="Send message">&#9654; Send</button>
  </div>

  <!-- ── Token counter ──────────────────────────────────────────── -->
  <div id="token-bar" aria-label="Usage statistics">
    <div class="token-stat">Messages: <span class="val" id="stat-msgs">0</span></div>
    <div class="token-stat">Tokens&nbsp;in: <span class="val" id="stat-in">—</span></div>
    <div class="token-stat">Tokens&nbsp;out: <span class="val" id="stat-out">—</span></div>
    <div class="spacer"></div>
    <span id="stat-model" style="color:var(--muted)"></span>
  </div>

  <script type="module" src="i18n.js"></script>
  <script>
    /* ═══════════════════════════════════════════════════════════════
       Intelli AI Chat — streaming SSE frontend
       Uses POST /chat/complete?stream=true  →  text/event-stream
       ═══════════════════════════════════════════════════════════════ */

    const GW = 'http://127.0.0.1:8080';

    /* ── State ─────────────────────────────────────────────────── */
    let _token    = sessionStorage.getItem('gw_token') || '';
    let _msgs     = [];   // [{role, content}]
    let _busy     = false;
    let _totalIn  = 0;
    let _totalOut = 0;

    /* ── DOM refs ───────────────────────────────────────────────── */
    const $loginBar   = document.getElementById('login-bar');
    const $loginToken = document.getElementById('login-token');
    const $btnLogin   = document.getElementById('btn-login');
    const $messages   = document.getElementById('messages');
    const $emptyState = document.getElementById('empty-state');
    const $msgInput   = document.getElementById('msg-input');
    const $btnSend    = document.getElementById('btn-send');
    const $btnClear   = document.getElementById('btn-clear');
    const $selProv    = document.getElementById('sel-provider');
    const $inpModel   = document.getElementById('inp-model');
    const $statusPill = document.getElementById('status-pill');
    const $statMsgs   = document.getElementById('stat-msgs');
    const $statIn     = document.getElementById('stat-in');
    const $statOut    = document.getElementById('stat-out');
    const $statModel  = document.getElementById('stat-model');

    /* ── Auth ───────────────────────────────────────────────────── */
    function applyToken(tok) {
      _token = tok.trim();
      if (_token) {
        sessionStorage.setItem('gw_token', _token);
        $loginBar.classList.add('hidden');
      } else {
        $loginBar.classList.remove('hidden');
      }
    }

    applyToken(_token);

    $btnLogin.addEventListener('click', () => {
      applyToken($loginToken.value);
    });
    $loginToken.addEventListener('keydown', e => {
      if (e.key === 'Enter') applyToken($loginToken.value);
    });

    /* ── Message rendering ──────────────────────────────────────── */
    function renderEmpty() {
      const has = _msgs.length > 0;
      $emptyState.style.display = has ? 'none' : 'flex';
    }

    function appendMsg(role, content, meta = {}) {
      const wrap = document.createElement('div');
      wrap.className = `msg ${role}`;

      const metaDiv = document.createElement('div');
      metaDiv.className = 'msg-meta';
      if (role === 'assistant') {
        const badge = document.createElement('span');
        badge.className = 'provider-badge';
        badge.textContent = meta.provider || $selProv.value;
        metaDiv.appendChild(badge);
        if (meta.model) {
          const m = document.createElement('span');
          m.textContent = meta.model;
          metaDiv.appendChild(m);
        }
      } else {
        metaDiv.textContent = 'You';
      }

      const body = document.createElement('div');
      body.className = 'msg-body';
      body.textContent = content;

      wrap.appendChild(metaDiv);
      wrap.appendChild(body);
      $messages.appendChild(wrap);
      $messages.scrollTop = $messages.scrollHeight;
      renderEmpty();
      return body;
    }

    function appendThinking() {
      const wrap = document.createElement('div');
      wrap.className = 'msg assistant';

      const metaDiv = document.createElement('div');
      metaDiv.className = 'msg-meta';
      const badge = document.createElement('span');
      badge.className = 'provider-badge';
      badge.textContent = $selProv.value;
      metaDiv.appendChild(badge);

      const body = document.createElement('div');
      body.className = 'msg-body thinking';
      body.textContent = 'Thinking';

      const cursor = document.createElement('span');
      cursor.className = 'cursor';
      body.appendChild(cursor);

      wrap.appendChild(metaDiv);
      wrap.appendChild(body);
      $messages.appendChild(wrap);
      $messages.scrollTop = $messages.scrollHeight;
      return { wrap, body };
    }

    /* ── Send ───────────────────────────────────────────────────── */
    async function sendMessage() {
      const text = $msgInput.value.trim();
      if (!text || _busy) return;
      if (!_token) {
        setStatus('⚠ Connect a token first', 'warn');
        $loginBar.classList.remove('hidden');
        return;
      }

      _busy = true;
      $btnSend.disabled = true;
      $msgInput.value = '';
      autoResize();

      _msgs.push({ role: 'user', content: text });
      appendMsg('user', text);
      updateStats();

      const { wrap: thinkingEl, body: thinkingBody } = appendThinking();
      setStatus('Streaming…', '');

      const provider = $selProv.value;
      const model    = $inpModel.value.trim();

      try {
        const resp = await fetch(`${GW}/chat/complete?stream=true`, {
          method:  'POST',
          headers: {
            'Content-Type':  'application/json',
            'Authorization': `Bearer ${_token}`,
          },
          body: JSON.stringify({
            provider,
            messages:    _msgs,
            model:       model || '',
            temperature: 0.7,
            max_tokens:  2048,
          }),
        });

        if (!resp.ok) {
          const errText = await resp.text();
          thinkingEl.remove();
          appendMsg('assistant', `Error ${resp.status}: ${errText}`).closest('.msg').querySelector('.msg-body').classList.add('error-msg');
          setStatus(`Error ${resp.status}`, 'err');
          _busy = false;
          $btnSend.disabled = false;
          return;
        }

        // Start streaming — replace the "Thinking" bubble with an empty content bubble
        thinkingBody.textContent = '';
        thinkingBody.classList.remove('thinking');
        const cursor = document.createElement('span');
        cursor.className = 'cursor';
        thinkingBody.appendChild(cursor);

        const reader  = resp.body.getReader();
        const decoder = new TextDecoder();
        let buf       = '';
        let fullContent = '';
        let finalResult = null;

        outer: while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buf += decoder.decode(value, { stream: true });
          const parts = buf.split('\n\n');
          buf = parts.pop(); // last possibly-incomplete chunk

          for (const part of parts) {
            const line = part.trim();
            if (!line.startsWith('data: ')) continue;
            const jsonStr = line.slice(6).trim();
            if (!jsonStr || jsonStr === '[DONE]') continue;

            let ev;
            try { ev = JSON.parse(jsonStr); } catch { continue; }

            if (ev.error) {
              cursor.remove();
              thinkingBody.textContent = `Error: ${ev.error}`;
              thinkingBody.classList.add('error-msg');
              setStatus('Error from provider', 'err');
              finalResult = null;
              break outer;
            }

            if (!ev.done) {
              // token event
              fullContent += ev.token || '';
              // Insert before cursor so cursor stays at end
              const textNode = document.createTextNode(ev.token || '');
              thinkingBody.insertBefore(textNode, cursor);
              $messages.scrollTop = $messages.scrollHeight;
            } else {
              // done=true final event
              finalResult = ev;
              break outer;
            }
          }
        }

        // Finalise message
        cursor.remove();
        if (finalResult && !finalResult.error) {
          const assistantContent = finalResult.content || fullContent;
          thinkingBody.textContent = assistantContent;
          _msgs.push({ role: 'assistant', content: assistantContent });

          // Update provider badge & model
          const badge = thinkingEl.querySelector('.provider-badge');
          if (badge) badge.textContent = finalResult.provider || provider;
          const metaDiv = thinkingEl.querySelector('.msg-meta');
          if (metaDiv && finalResult.model) {
            let modelSpan = metaDiv.querySelector('.model-name');
            if (!modelSpan) {
              modelSpan = document.createElement('span');
              modelSpan.className = 'model-name';
              metaDiv.appendChild(modelSpan);
            }
            modelSpan.textContent = finalResult.model;
            $statModel.textContent = finalResult.model;
          }

          // Update token counts
          const usage = finalResult.usage || {};
          if (usage.prompt_tokens)     { _totalIn  += usage.prompt_tokens;     }
          if (usage.completion_tokens) { _totalOut += usage.completion_tokens; }
          updateStats();
        }

        setStatus('Ready', 'ok');
      } catch (err) {
        thinkingEl.remove();
        appendMsg('assistant', `Network error: ${err.message}`);
        setStatus('Network error', 'err');
      }

      _busy = false;
      $btnSend.disabled = false;
      $messages.scrollTop = $messages.scrollHeight;
      $msgInput.focus();
    }

    /* ── Helpers ────────────────────────────────────────────────── */
    function setStatus(msg, cls) {
      $statusPill.textContent = msg;
      $statusPill.style.color = cls === 'ok'   ? 'var(--green)'
                              : cls === 'err'  ? 'var(--red)'
                              : cls === 'warn' ? 'var(--yellow)'
                              : 'var(--muted)';
    }

    function updateStats() {
      $statMsgs.textContent = _msgs.filter(m => m.role === 'user').length;
      $statIn.textContent   = _totalIn  || '—';
      $statOut.textContent  = _totalOut || '—';
    }

    function autoResize() {
      $msgInput.style.height = 'auto';
      $msgInput.style.height = Math.min($msgInput.scrollHeight, 120) + 'px';
    }

    /* ── Event wiring ───────────────────────────────────────────── */
    $btnSend.addEventListener('click', sendMessage);

    $msgInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    $msgInput.addEventListener('input', autoResize);

    $btnClear.addEventListener('click', () => {
      _msgs      = [];
      _totalIn   = 0;
      _totalOut  = 0;
      $messages.innerHTML = '';
      $messages.appendChild($emptyState);
      $emptyState.style.display = 'flex';
      $statModel.textContent    = '';
      updateStats();
      setStatus('', '');
      $msgInput.focus();
    });

    /* ── Provider change: check availability ───────────────────── */
    $selProv.addEventListener('change', async () => {
      if (!_token) return;
      const prov = $selProv.value;
      setStatus(`Checking ${prov}…`, '');
      try {
        const r = await fetch(`${GW}/admin/providers/${prov}/health`, {
          headers: { 'Authorization': `Bearer ${_token}` },
        });
        if (r.ok) {
          const d = await r.json();
          const icons = { ok: '✓', no_key: '✗', unavailable: '!' };
          const cols  = { ok: 'ok', no_key: 'err', unavailable: 'warn' };
          setStatus(`${icons[d.status] || '?'} ${prov}`, cols[d.status] || '');
        }
      } catch { setStatus('', ''); }
    });

    /* ── Init ───────────────────────────────────────────────────── */
    setStatus('Ready', 'ok');
    $msgInput.focus();
  </script>
</body>
</html>
