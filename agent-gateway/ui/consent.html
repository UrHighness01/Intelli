<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/ui/intelli-logo.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intelli Â· Context-Sharing Timeline</title>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --border: #2d3145;
      --accent: #6c63ff;
      --accent-dim: #3d3870;
      --text: #e2e4f0;
      --muted: #7b7f9e;
      --low: #2ecc71;
      --medium: #f39c12;
      --high: #e74c3c;
      --mono: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 14px;
      min-height: 100vh;
    }
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { font-size: 16px; font-weight: 600; color: var(--accent); }
    header .spacer { flex: 1; }
    #status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--muted); display: inline-block;
      transition: background .3s;
    }
    #status-dot.ok { background: var(--low); }
    #status-dot.err { background: var(--high); }

    /* Login */
    #login-panel {
      max-width: 380px; margin: 80px auto;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; padding: 32px;
    }
    #login-panel h2 { margin-bottom: 20px; font-size: 18px; }
    label { display: block; margin-bottom: 6px; color: var(--muted);
            font-size: 12px; text-transform: uppercase; letter-spacing: .06em; }
    input[type=text], input[type=password] {
      width: 100%; padding: 9px 12px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); font-size: 14px;
      margin-bottom: 16px; outline: none;
    }
    input:focus { border-color: var(--accent); }
    button {
      background: var(--accent); color: #fff; border: none;
      padding: 9px 20px; border-radius: 6px; cursor: pointer;
      font-size: 14px; font-weight: 500;
    }
    button:hover { background: #7d76ff; }
    button.secondary {
      background: transparent; border: 1px solid var(--border); color: var(--muted);
    }
    button.secondary:hover { border-color: var(--accent); color: var(--text); }
    button.danger {
      background: transparent; border: 1px solid var(--high); color: var(--high);
    }
    button.danger:hover { background: var(--high); color: #fff; }
    #login-error { color: var(--high); font-size: 13px; margin-top: 10px; min-height: 18px; }

    /* Main layout */
    #app { display: none; flex-direction: column; height: 100vh; }
    #toolbar {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 10px 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    #toolbar input[type=text] { margin-bottom: 0; width: 240px; }
    #toolbar select {
      padding: 8px 10px; background: var(--bg); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); font-size: 13px; outline: none;
    }
    #entry-count { color: var(--muted); font-size: 12px; margin-left: auto; }

    /* Timeline list */
    #timeline-list {
      flex: 1; overflow-y: auto; padding: 16px 20px;
      display: flex; flex-direction: column; gap: 10px;
    }

    /* Entry card */
    .entry-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 14px 16px;
      transition: border-color .15s;
      cursor: default;
    }
    .entry-card:hover { border-color: var(--accent-dim); }

    .entry-header {
      display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px;
    }
    .entry-ts { color: var(--muted); font-size: 11px; font-family: var(--mono); white-space: nowrap; }
    .entry-url {
      font-size: 13px; color: var(--text); font-weight: 500;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      flex: 1; min-width: 0;
    }
    .entry-origin {
      font-size: 11px; color: var(--muted); margin-top: 2px;
    }
    .entry-actor {
      font-size: 11px; font-family: var(--mono);
      background: var(--accent-dim); color: var(--accent);
      padding: 2px 6px; border-radius: 4px; white-space: nowrap;
    }

    .entry-body { display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px; }

    .field-group label {
      display: block; font-size: 10px; text-transform: uppercase;
      letter-spacing: .06em; color: var(--muted); margin-bottom: 4px;
    }
    .field-pills { display: flex; flex-wrap: wrap; gap: 4px; }
    .pill {
      font-family: var(--mono); font-size: 11px;
      padding: 2px 7px; border-radius: 12px;
      background: #23263a; border: 1px solid var(--border);
      color: var(--text);
    }
    .pill.redacted {
      background: #2e1a1a; border-color: #5a2020; color: var(--high);
    }
    .pill.none { color: var(--muted); font-style: italic; }

    .entry-meta { display: flex; gap: 16px; align-items: center; }
    .meta-item { display: flex; align-items: center; gap: 4px; }
    .meta-item .key { color: var(--muted); }
    .meta-item .val { font-family: var(--mono); color: var(--text); }

    /* Empty / loading states */
    .placeholder {
      text-align: center; color: var(--muted); margin: 60px auto;
      font-size: 14px; line-height: 1.8;
    }

    /* Confirm modal */
    #confirm-modal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.6); z-index: 100;
      align-items: center; justify-content: center;
    }
    #confirm-modal.show { display: flex; }
    #confirm-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; padding: 28px 32px; max-width: 420px; width: 90%;
    }
    #confirm-box h3 { margin-bottom: 12px; font-size: 16px; }
    #confirm-box p { color: var(--muted); font-size: 13px; margin-bottom: 24px; line-height: 1.6; }
    #confirm-box .btn-row { display: flex; gap: 10px; justify-content: flex-end; }
  </style>
</head>
<body>

<!-- Header (always visible) -->
<header>
  <span>ðŸ”’</span>
  <h1>Context-Sharing Timeline</h1>
  <span class="spacer"></span>
  <span id="status-dot"></span>
  <span id="status-text" style="font-size:12px;color:var(--muted);">â€”</span>
</header>

<!-- Login panel -->
<div id="login-panel">
  <h2>Admin Login</h2>
  <label for="u">Username</label>
  <input type="text" id="u" value="admin" autocomplete="username" />
  <label for="p">Password</label>
  <input type="password" id="p" autocomplete="current-password" />
  <button id="login-btn">Sign in</button>
  <div id="login-error"></div>
</div>

<!-- Main app -->
<div id="app">
  <div id="toolbar">
    <input type="text" id="filter-origin" placeholder="Filter by originâ€¦" />
    <select id="filter-limit">
      <option value="50">50 entries</option>
      <option value="100" selected>100 entries</option>
      <option value="250">250 entries</option>
      <option value="500">500 entries</option>
    </select>
    <button class="secondary" id="refresh-btn">â†» Refresh</button>
    <button class="danger" id="clear-btn">ðŸ—‘ Clear timelineâ€¦</button>
    <span id="entry-count"></span>
  </div>
  <div id="timeline-list">
    <div class="placeholder" id="placeholder">Loadingâ€¦</div>
  </div>
</div>

<!-- Confirm modal -->
<div id="confirm-modal">
  <div id="confirm-box">
    <h3 id="confirm-title">Confirm clear</h3>
    <p id="confirm-msg"></p>
    <div class="btn-row">
      <button class="secondary" id="confirm-cancel">Cancel</button>
      <button class="danger" id="confirm-ok">Clear</button>
    </div>
  </div>
</div>

<script>
  const BASE = '';   // same origin
  let _token = '';
  let _clearOrigin = null;

  // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const loginPanel   = document.getElementById('login-panel');
  const appEl        = document.getElementById('app');
  const loginBtn     = document.getElementById('login-btn');
  const loginError   = document.getElementById('login-error');
  const uEl          = document.getElementById('u');
  const pEl          = document.getElementById('p');
  const filterOrigin = document.getElementById('filter-origin');
  const filterLimit  = document.getElementById('filter-limit');
  const refreshBtn   = document.getElementById('refresh-btn');
  const clearBtn     = document.getElementById('clear-btn');
  const entryCount   = document.getElementById('entry-count');
  const list         = document.getElementById('timeline-list');
  const placeholder  = document.getElementById('placeholder');
  const statusDot    = document.getElementById('status-dot');
  const statusText   = document.getElementById('status-text');
  const confirmModal = document.getElementById('confirm-modal');
  const confirmTitle = document.getElementById('confirm-title');
  const confirmMsg   = document.getElementById('confirm-msg');
  const confirmCancel= document.getElementById('confirm-cancel');
  const confirmOk    = document.getElementById('confirm-ok');

  // â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pEl.addEventListener('keydown', e => e.key === 'Enter' && login());
  loginBtn.addEventListener('click', login);

  async function login() {
    loginError.textContent = '';
    const res = await fetch(`${BASE}/admin/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: uEl.value.trim(), password: pEl.value }),
    }).catch(() => null);
    if (!res || !res.ok) {
      loginError.textContent = 'Login failed â€” check credentials.';
      return;
    }
    const data = await res.json();
    _token = data.token || '';
    localStorage.setItem('gw_token', _token);
    loginPanel.style.display = 'none';
    appEl.style.display = 'flex';
    loadTimeline();
  }

  // â”€â”€ Auto-login from shared token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function tryAutoLogin() {
    const saved = localStorage.getItem('gw_token');
    if (saved) {
      _token = saved;
      loginPanel.style.display = 'none';
      appEl.style.display = 'flex';
      loadTimeline();
    }
  })();

  function authHeaders() {
    return { 'Authorization': `Bearer ${_token}`, 'Content-Type': 'application/json' };
  }

  // â”€â”€ Timeline fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  filterOrigin.addEventListener('input', debounce(loadTimeline, 400));
  filterLimit.addEventListener('change', loadTimeline);
  refreshBtn.addEventListener('click', loadTimeline);

  async function loadTimeline() {
    const origin = filterOrigin.value.trim();
    const limit  = filterLimit.value;
    const params = new URLSearchParams({ limit });
    if (origin) params.set('origin', origin);

    const res = await fetch(`${BASE}/consent/timeline?${params}`, {
      headers: authHeaders(),
    }).catch(() => null);

    if (!res || !res.ok) {
      setStatus('err', 'Failed to load');
      placeholder.textContent = 'Could not load timeline â€” check auth.';
      placeholder.style.display = 'block';
      return;
    }

    const data = await res.json();
    const entries = Array.isArray(data) ? data : (data.entries || data.timeline || []);
    setStatus('ok', 'Live');
    renderEntries(entries);
  }

  function renderEntries(entries) {
    // Remove old cards
    [...list.querySelectorAll('.entry-card')].forEach(el => el.remove());

    if (!entries.length) {
      placeholder.textContent = 'No consent events recorded yet.';
      placeholder.style.display = 'block';
      entryCount.textContent = '0 entries';
      return;
    }

    placeholder.style.display = 'none';
    entryCount.textContent = `${entries.length} entr${entries.length === 1 ? 'y' : 'ies'}`;

    entries.forEach(e => {
      const card = document.createElement('div');
      card.className = 'entry-card';
      card.innerHTML = buildCard(e);
      list.appendChild(card);
    });
  }

  function buildCard(e) {
    const ts = formatTs(e.ts);
    const fields    = (e.fields   || []);
    const redacted  = new Set(e.redacted || []);
    const actor     = e.actor || 'anonymous';
    const selLen    = e.selected_text_len || 0;
    const title     = e.title || '';

    const fieldPills = fields.length
      ? fields.map(f => `<span class="pill${redacted.has(f) ? ' redacted' : ''}" title="${redacted.has(f) ? 'Redacted before sharing' : ''}">${esc(f)}</span>`).join('')
      : '<span class="pill none">none</span>';

    return `
      <div class="entry-header">
        <div style="flex:1;min-width:0">
          <div class="entry-url" title="${esc(e.url || '')}">${esc(e.url || 'â€”')}</div>
          ${title ? `<div class="entry-origin">${esc(title)}</div>` : ''}
          <div class="entry-origin">${esc(e.origin || '')}</div>
        </div>
        <span class="entry-actor">${esc(actor)}</span>
        <span class="entry-ts">${ts}</span>
      </div>
      <div class="entry-body">
        <div class="field-group">
          <label>Input fields shared</label>
          <div class="field-pills">${fieldPills}</div>
        </div>
        <div class="field-group">
          <label>Selected text</label>
          <div class="field-pills">${selLen
            ? `<span class="pill">${selLen} chars</span>`
            : '<span class="pill none">none</span>'
          }</div>
        </div>
      </div>`;
  }

  // â”€â”€ Clear timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  clearBtn.addEventListener('click', () => {
    const origin = filterOrigin.value.trim();
    _clearOrigin = origin || null;
    confirmTitle.textContent = origin ? `Clear entries for "${origin}"` : 'Clear entire timeline';
    confirmMsg.textContent   = origin
      ? `This will permanently delete all consent timeline entries for the origin "${origin}". This cannot be undone.`
      : 'This will permanently delete ALL consent timeline entries. This cannot be undone.';
    confirmModal.classList.add('show');
  });

  confirmCancel.addEventListener('click', () => confirmModal.classList.remove('show'));

  confirmOk.addEventListener('click', async () => {
    confirmModal.classList.remove('show');
    const params = new URLSearchParams();
    if (_clearOrigin) params.set('origin', _clearOrigin);

    const res = await fetch(`${BASE}/consent/timeline?${params}`, {
      method: 'DELETE',
      headers: authHeaders(),
    }).catch(() => null);

    if (res && res.ok) loadTimeline();
    else alert('Failed to clear timeline.');
  });

  // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(state, msg) {
    statusDot.className = 'ok' === state ? 'ok' : 'err';
    statusText.textContent = msg;
  }

  function formatTs(ts) {
    if (!ts) return 'â€”';
    try {
      const d = new Date(ts);
      return d.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'medium' });
    } catch { return ts; }
  }

  function esc(s) {
    return String(s || '')
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  function debounce(fn, ms) {
    let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
  }
</script>
  <script type="module" src="i18n.js"></script>
</body>
</html>
