<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Intelli â€” Personas</title>
<style>
  :root {
    --surface:  #1a1d27;
    --surface2: #21253a;
    --border:   #2d3145;
    --accent:   #6e9ef5;
    --green:    #3ddc84;
    --red:      #ff6b6b;
    --text:     #e2e4f0;
    --muted:    #7b7f9e;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--surface); color: var(--text);
    height: 100vh; display: flex; flex-direction: column; overflow: hidden;
  }

  #header {
    background: var(--surface2); border-bottom: 1px solid var(--border);
    padding: 10px 14px; display: flex; align-items: center; gap: 10px; flex-shrink: 0;
  }
  #header h1 { font-size: 1rem; font-weight: 600; flex: 1; }
  .hdr-btn {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    color: var(--muted); padding: 4px 10px; cursor: pointer; font-size: .8rem;
    text-decoration: none; display: inline-block;
  }
  .hdr-btn:hover { border-color: var(--accent); color: var(--accent); }
  .hdr-btn.primary { background: var(--accent); color: #0d1117; border-color: var(--accent); font-weight: 600; }
  .hdr-btn.primary:hover { opacity: .88; }

  #main { display: flex; flex: 1; overflow: hidden; }

  /* â”€â”€ Persona list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #list-pane {
    width: 280px; min-width: 200px; border-right: 1px solid var(--border);
    overflow-y: auto; flex-shrink: 0;
  }
  .persona-item {
    padding: 10px 14px; border-bottom: 1px solid var(--border);
    cursor: pointer; display: flex; align-items: center; gap: 10px;
    transition: background .12s;
  }
  .persona-item:hover { background: var(--surface2); }
  .persona-item.selected { background: var(--surface2); border-left: 3px solid var(--accent); padding-left: 11px; }
  .persona-avatar { font-size: 1.5rem; }
  .persona-name { font-size: .88rem; font-weight: 600; }
  .persona-sub  { font-size: .7rem; color: var(--muted); }
  .builtin-badge {
    font-size: .62rem; padding: 1px 5px; border-radius: 8px;
    border: 1px solid var(--muted); color: var(--muted);
  }

  /* â”€â”€ Editor pane â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #editor-pane {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
  }
  #editor-header {
    background: var(--surface2); border-bottom: 1px solid var(--border);
    padding: 10px 14px; display: flex; align-items: center; gap: 8px; flex-shrink: 0;
  }
  #editor-header h2 { font-size: .9rem; font-weight: 600; flex: 1; color: var(--muted); }
  .action-btn {
    border: 1px solid var(--border); border-radius: 6px; padding: 4px 12px;
    font-size: .78rem; cursor: pointer; background: none; color: var(--muted);
  }
  .action-btn:hover { border-color: var(--accent); color: var(--accent); }
  .action-btn.danger:hover { border-color: var(--red); color: var(--red); }
  .action-btn.primary {
    background: var(--accent); color: #0d1117;
    border-color: var(--accent); font-weight: 600;
  }
  .action-btn.primary:hover { opacity: .88; }

  #editor-form {
    flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 14px;
  }
  .field label { font-size: .78rem; color: var(--muted); display: block; margin-bottom: 4px; }
  .field input, .field select, .field textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text); padding: 7px 10px; font-size: .85rem; outline: none;
    font-family: inherit;
  }
  .field input:focus, .field textarea:focus { border-color: var(--accent); }
  .field textarea { resize: vertical; min-height: 180px; font-family: monospace; font-size: .82rem; line-height: 1.5; }
  .field-row { display: flex; gap: 10px; }
  .field-row .field { flex: 1; }

  #editor-placeholder {
    flex: 1; display: flex; align-items: center; justify-content: center;
    color: var(--muted); font-size: .9rem;
  }
  #status-bar {
    padding: 5px 14px; font-size: .72rem; color: var(--muted);
    border-top: 1px solid var(--border); flex-shrink: 0;
  }

  /* â”€â”€ Create form (collapsible below list) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #create-section {
    border-top: 1px solid var(--border); padding: 10px 14px; flex-shrink: 0;
    background: var(--surface);
  }
  #btn-new-persona {
    width: 100%; background: none; border: 1px dashed var(--border);
    border-radius: 6px; color: var(--muted); padding: 7px; cursor: pointer; font-size: .82rem;
  }
  #btn-new-persona:hover { border-color: var(--accent); color: var(--accent); }
</style>
</head>
<body>

<div id="header">
  <h1>ğŸ­ Agent Personas</h1>
  <a class="hdr-btn" href="chat.html">â† Chat</a>
  <a class="hdr-btn" href="index.html">âš™ Hub</a>
</div>

<div id="main">
  <!-- List -->
  <div id="list-pane">
    <div id="persona-list"></div>
    <div id="create-section">
      <button id="btn-new-persona" onclick="startCreate()">ï¼‹ New persona</button>
    </div>
  </div>

  <!-- Editor -->
  <div id="editor-pane">
    <div id="editor-header" style="display:none">
      <h2 id="editor-title">Persona</h2>
      <button class="action-btn primary" id="btn-save" onclick="savePersona()">ğŸ’¾ Save</button>
      <button class="action-btn danger" id="btn-delete" onclick="deletePersona()">âœ• Delete</button>
    </div>
    <div id="editor-form" style="display:none">
      <div class="field-row">
        <div class="field">
          <label>Name *</label>
          <input id="f-name" placeholder="e.g. Research Assistant" />
        </div>
        <div class="field" style="max-width:80px">
          <label>Avatar</label>
          <input id="f-avatar" placeholder="ğŸ¤–" maxlength="4" />
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Preferred provider <span style="color:var(--muted)">(optional)</span></label>
          <select id="f-provider">
            <option value="">â€” use chat selection â€”</option>
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic</option>
            <option value="openrouter">OpenRouter</option>
            <option value="ollama">Ollama</option>
          </select>
        </div>
        <div class="field">
          <label>Preferred model <span style="color:var(--muted)">(optional)</span></label>
          <input id="f-model" placeholder="e.g. gpt-4o" />
        </div>
      </div>
      <div class="field">
        <label>SOUL.md â€” Personality &amp; system prompt</label>
        <textarea id="f-soul" placeholder="Describe this persona's personality, expertise, tone, and objectivesâ€¦"></textarea>
      </div>
    </div>
    <div id="editor-placeholder">â† Select a persona to edit, or create a new one</div>
  </div>
</div>

<div id="status-bar">Ready.</div>

<script>
const GW = '';
const TOKEN = (() => { try { return localStorage.getItem('gw_token') || ''; } catch { return ''; } })();
function authH() { return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` }; }

// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
let _personas    = [];
let _selectedSlug = null;
let _isNew       = false;

// ---------------------------------------------------------------------------
// Status
// ---------------------------------------------------------------------------
function setStatus(msg, ok = true) {
  const el = document.getElementById('status-bar');
  el.textContent = msg;
  el.style.color = ok ? 'var(--muted)' : 'var(--red)';
}

// ---------------------------------------------------------------------------
// Load personas from API
// ---------------------------------------------------------------------------
async function loadPersonas() {
  try {
    const r = await fetch(`${GW}/personas`, { headers: authH() });
    if (!r.ok) throw new Error(await r.text());
    _personas = await r.json();
    renderList();
  } catch (e) {
    setStatus(`Load failed: ${e.message}`, false);
  }
}

// ---------------------------------------------------------------------------
// Render list
// ---------------------------------------------------------------------------
function renderList() {
  const ul = document.getElementById('persona-list');
  ul.innerHTML = _personas.map(p => `
    <div class="persona-item${p.slug === _selectedSlug ? ' selected' : ''}"
         onclick="selectPersona('${esc(p.slug)}')">
      <span class="persona-avatar">${p.avatar || 'ğŸ¤–'}</span>
      <div>
        <div class="persona-name">${esc(p.name)}
          ${p.builtin ? '<span class="builtin-badge">built-in</span>' : ''}
        </div>
        <div class="persona-sub">${esc((p.soul || '').slice(0, 60))}${(p.soul||'').length > 60 ? 'â€¦' : ''}</div>
      </div>
    </div>`).join('');
}

function esc(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ---------------------------------------------------------------------------
// Select a persona to edit
// ---------------------------------------------------------------------------
function selectPersona(slug) {
  _selectedSlug = slug;
  _isNew = false;
  const p = _personas.find(x => x.slug === slug);
  if (!p) return;
  showEditor(p.name);
  document.getElementById('f-name').value     = p.name;
  document.getElementById('f-avatar').value   = p.avatar || 'ğŸ¤–';
  document.getElementById('f-provider').value = p.provider || '';
  document.getElementById('f-model').value    = p.model || '';
  document.getElementById('f-soul').value     = p.soul || '';
  // Disable editing of built-in persona
  const isBuiltin = !!p.builtin;
  ['f-name','f-avatar','f-provider','f-model','f-soul'].forEach(id => {
    document.getElementById(id).disabled = isBuiltin;
  });
  document.getElementById('btn-save').disabled   = isBuiltin;
  document.getElementById('btn-delete').disabled = isBuiltin;
  document.getElementById('btn-delete').style.display = isBuiltin ? 'none' : '';
  renderList();
}

// ---------------------------------------------------------------------------
// Create mode
// ---------------------------------------------------------------------------
function startCreate() {
  _selectedSlug = null;
  _isNew = true;
  showEditor('New Persona');
  document.getElementById('f-name').value     = '';
  document.getElementById('f-avatar').value   = 'ğŸ¤–';
  document.getElementById('f-provider').value = '';
  document.getElementById('f-model').value    = '';
  document.getElementById('f-soul').value     = '';
  ['f-name','f-avatar','f-provider','f-model','f-soul'].forEach(id => {
    document.getElementById(id).disabled = false;
  });
  document.getElementById('btn-save').disabled   = false;
  document.getElementById('btn-delete').style.display = 'none';
  renderList();
}

function showEditor(title) {
  document.getElementById('editor-header').style.display    = 'flex';
  document.getElementById('editor-form').style.display      = 'flex';
  document.getElementById('editor-placeholder').style.display = 'none';
  document.getElementById('editor-title').textContent = title;
}

// ---------------------------------------------------------------------------
// Save (create or update)
// ---------------------------------------------------------------------------
async function savePersona() {
  const name     = document.getElementById('f-name').value.trim();
  const avatar   = document.getElementById('f-avatar').value.trim() || 'ğŸ¤–';
  const provider = document.getElementById('f-provider').value;
  const model    = document.getElementById('f-model').value.trim();
  const soul     = document.getElementById('f-soul').value;

  if (!name) { alert('Name is required.'); return; }

  try {
    let r;
    if (_isNew) {
      r = await fetch(`${GW}/personas`, {
        method: 'POST', headers: authH(),
        body: JSON.stringify({ name, avatar, provider, model, soul }),
      });
    } else {
      r = await fetch(`${GW}/personas/${encodeURIComponent(_selectedSlug)}`, {
        method: 'PUT', headers: authH(),
        body: JSON.stringify({ name, avatar, provider, model, soul }),
      });
    }
    if (!r.ok) throw new Error(await r.text());
    const saved = await r.json();
    setStatus(`Persona '${saved.name}' saved.`);
    _isNew = false;
    _selectedSlug = saved.slug;
    await loadPersonas();
    selectPersona(saved.slug);
  } catch (e) {
    setStatus(`Save failed: ${e.message}`, false);
  }
}

// ---------------------------------------------------------------------------
// Delete
// ---------------------------------------------------------------------------
async function deletePersona() {
  if (!_selectedSlug || _selectedSlug === 'intelli') return;
  if (!confirm(`Delete persona '${_selectedSlug}'?`)) return;
  try {
    const r = await fetch(`${GW}/personas/${encodeURIComponent(_selectedSlug)}`, {
      method: 'DELETE', headers: authH(),
    });
    if (!r.ok) throw new Error(await r.text());
    setStatus(`Persona deleted.`);
    _selectedSlug = null;
    document.getElementById('editor-header').style.display = 'none';
    document.getElementById('editor-form').style.display   = 'none';
    document.getElementById('editor-placeholder').style.display = 'flex';
    await loadPersonas();
  } catch (e) {
    setStatus(`Delete failed: ${e.message}`, false);
  }
}

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
loadPersonas();
</script>
</body>
</html>
